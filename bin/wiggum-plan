#!/usr/bin/env bash
# wiggum plan - Create implementation plan for a task
#
# Usage:
#   wiggum plan <TASK-ID>    Create implementation plan (read-only exploration)

set -euo pipefail

WIGGUM_HOME="${WIGGUM_HOME:-$HOME/.claude/chief-wiggum}"
PROJECT_DIR="$(pwd)"
RALPH_DIR="${RALPH_DIR:-$PROJECT_DIR/.ralph}"

source "$WIGGUM_HOME/lib/core/exit-codes.sh"
source "$WIGGUM_HOME/lib/core/verbose-flags.sh"
source "$WIGGUM_HOME/lib/core/logger.sh"
source "$WIGGUM_HOME/lib/tasks/task-parser.sh"
source "$WIGGUM_HOME/lib/worker/agent-registry.sh"
source "$WIGGUM_HOME/lib/claude/usage-tracker.sh"

# Recompute usage at startup (ensures rate limit checks use fresh data)
if [ -d "$RALPH_DIR" ]; then
    usage_tracker_write_shared "$RALPH_DIR" > /dev/null 2>&1 || true
fi

show_help() {
    cat << EOF
wiggum plan - Create implementation plan for a task

Usage:
  wiggum plan <id>    Create implementation plan for the specified task

This command runs the plan-mode agent which:
- Explores the codebase in READ-ONLY mode
- Analyzes requirements from the task PRD
- Identifies existing patterns and conventions
- Creates a detailed implementation plan

The plan is saved to: .ralph/plans/TASK-xxx.md

Task ID Resolution:
  Task IDs can be partial as long as they match exactly one task:
  - 030                (number only)
  - K-030              (partial task ID)
  - TASK-030           (full task ID)

Options:
  -v, --verbose   Verbose output (same as default)
  -vv             Debug output (detailed diagnostics)
  -vvv            Trace output (very detailed tracing)
  -q, --quiet     Quiet mode (warnings and errors only)
  -h, --help      Show this help message

Examples:
  wiggum plan TASK-030     # Create plan for TASK-030
  wiggum plan 030          # Create plan matching "030"
  wiggum plan FEAT-001     # Create plan for FEAT-001

Notes:
  - The task must exist in .ralph/kanban.md
  - This runs in the foreground (blocking)
  - Plans are stored in .ralph/plans/
  - Use 'wiggum start' to execute the task after planning

EOF
}

# Create implementation plan for a task
do_plan() {
    local input_id="$1"

    if [ -z "$input_id" ]; then
        echo "Error: Task ID required"
        echo "Usage: wiggum plan <TASK-ID>"
        exit $EXIT_WORKER_MISSING_TASK_ID
    fi

    # Validate task ID format (alphanumeric and hyphens only)
    if ! [[ "$input_id" =~ ^[A-Za-z0-9-]+$ ]]; then
        echo "Error: Invalid task ID format: $input_id"
        echo "Task IDs may only contain letters, numbers, and hyphens"
        exit $EXIT_USAGE
    fi

    # Check .ralph directory exists
    if [ ! -d "$RALPH_DIR" ]; then
        echo "Error: No .ralph directory found. Run 'wiggum init' first."
        exit $EXIT_WORKER_NO_RALPH_DIR
    fi

    # Check if kanban exists
    if [ ! -f "$RALPH_DIR/kanban.md" ]; then
        echo "Error: No kanban.md found at $RALPH_DIR/kanban.md"
        exit $EXIT_WORKER_NO_KANBAN
    fi

    # Resolve partial task ID to full task ID
    local task_id
    task_id=$(resolve_task_id "$RALPH_DIR/kanban.md" "$input_id") || exit $EXIT_WORKER_TASK_NOT_FOUND

    # Create planning worker directory with unique timestamp
    local timestamp
    timestamp=$(date +%s)
    local worker_id="worker-${task_id}-plan-${timestamp}"
    local worker_dir="$RALPH_DIR/workers/$worker_id"

    mkdir -p "$worker_dir"
    mkdir -p "$RALPH_DIR/logs"
    mkdir -p "$RALPH_DIR/plans"

    # Initialize logging for plan command
    export LOG_FILE="$RALPH_DIR/logs/plan.log"
    source "$WIGGUM_HOME/lib/utils/activity-log.sh"
    activity_init "$PROJECT_DIR"

    log "Planning task $task_id"
    log_debug "worker_id=$worker_id"
    log_debug "worker_dir=$worker_dir"
    activity_log "plan.started" "$worker_id" "$task_id"

    # Extract task from kanban and create worker PRD
    extract_task "$task_id" "$RALPH_DIR/kanban.md" > "$worker_dir/prd.md"

    echo "Creating implementation plan for $task_id"
    echo "Worker: $worker_id"

    # Run plan-mode agent in foreground (blocking)
    run_agent "product.plan-mode" "$worker_dir" "$PROJECT_DIR"
    local result=$?

    # Report result
    local plan_file="$RALPH_DIR/plans/${task_id}.md"
    if [ $result -eq 0 ] && [ -f "$plan_file" ]; then
        log "Planning completed successfully for task $task_id"
        activity_log "plan.completed" "$worker_id" "$task_id" "exit_code=$result"
        echo ""
        echo "Plan saved to: .ralph/plans/${task_id}.md"
        echo ""
        echo "Next steps:"
        echo "  cat .ralph/plans/${task_id}.md  # Review the plan"
        echo "  wiggum start $task_id           # Start task execution"
    else
        log_error "Planning failed for task $task_id (exit_code=$result)"
        activity_log "plan.failed" "$worker_id" "$task_id" "exit_code=$result"
        echo ""
        echo "Planning did not complete successfully (exit: $result)"
        if [ -f "$worker_dir/plan-output.md" ]; then
            echo "Partial plan available at: $worker_dir/plan-output.md"
        fi
    fi

    return $result
}

# Main
main() {
    # Parse verbose flags first
    parse_verbose_flags "$@"
    set -- "${WIGGUM_REMAINING_ARGS[@]}"

    # Handle help
    if [[ "${1:-}" == "-h" || "${1:-}" == "--help" ]]; then
        show_help
        exit $EXIT_OK
    fi

    # Require task ID
    if [ $# -eq 0 ]; then
        echo "Error: Task ID required"
        echo "Usage: wiggum plan <TASK-ID>"
        exit $EXIT_WORKER_MISSING_TASK_ID
    fi

    do_plan "$1"
}

main "$@"
