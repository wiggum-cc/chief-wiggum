#!/usr/bin/env bash
# Initialize .ralph/ directory in a project
set -euo pipefail

WIGGUM_HOME="${WIGGUM_HOME:-$HOME/.claude/chief-wiggum}"
source "$WIGGUM_HOME/lib/core/exit-codes.sh"
source "$WIGGUM_HOME/lib/core/defaults.sh"

show_help() {
    cat << EOF
wiggum init - Initialize Chief Wiggum in current project

Usage: wiggum init [options]

Options:
  -h, --help          Show this help message

Description:
  Creates the .ralph/ directory structure in the current project:
    - .ralph/kanban.md    Task board
    - .ralph/changelog.md Completion log
    - .ralph/workers/     Worker directories
    - .ralph/results/     Task results
    - .ralph/logs/        Worker logs

  Requires a git repository to function properly.

Examples:
  wiggum init          # Initialize Chief Wiggum in current project

EOF
}

# Parse options
while [[ $# -gt 0 ]]; do
    case "$1" in
        -h|--help)
            show_help
            exit $EXIT_OK
            ;;
        *)
            echo "Unknown option: $1"
            echo ""
            show_help
            exit $EXIT_USAGE
            ;;
    esac
done

echo "Initializing Chief Wiggum in $PROJECT_DIR"

# Check if git repo
if [ ! -d ".git" ]; then
    echo "WARNING: Not a git repository. Chief Wiggum requires git for worker isolation."
    echo "Run 'git init' first."
    exit $EXIT_INIT_NOT_GIT_REPO
fi

# Create .ralph/ structure
mkdir -p "$RALPH_DIR/workers"
mkdir -p "$RALPH_DIR/results"
mkdir -p "$RALPH_DIR/logs"

# Create .gitignore to exclude .ralph/ contents from version control
cat > "$RALPH_DIR/.gitignore" <<'EOF'
*
!.gitignore
EOF

# Create kanban template if it doesn't exist
if [ ! -f "$RALPH_DIR/kanban.md" ]; then
    cat > "$RALPH_DIR/kanban.md" <<'EOF'
# Project Kanban

<!-- Task format: - [ ] **[ID-###]** Title
     Task ID: 2-10 letter prefix, dash, 1-4 digit number (e.g., TASK-001, BUG-42, FEATURE-1)
     Required: Description, Priority (CRITICAL|HIGH|MEDIUM|LOW), Dependencies (task IDs or "none")
     Optional: Complexity (HIGH|MEDIUM|LOW), Agent (task-worker), Scope, Out of Scope, Acceptance Criteria
     Status: [ ] pending, [=] in-progress, [P] pending approval, [x] complete, [*] failed, [N] not planned -->

## TASKS

- [ ] **[TASK-001]** Example task demonstrating all available fields
  - Description: This is a comprehensive example showing all supported fields. Replace this with your actual tasks. The Description field provides detailed context about what needs to be done.
  - Priority: HIGH
  - Complexity: MEDIUM
  - Dependencies: none
  - Agent: task-worker
  - Scope:
    - First specific deliverable or action item
    - Second specific deliverable or action item
    - Third specific deliverable or action item
  - Out of Scope:
    - Related work that should NOT be included
    - Future enhancements to defer for later tasks
  - Acceptance Criteria:
    - Specific condition that must be met for completion
    - Another measurable success criterion
    - Final validation checkpoint

EOF
    echo "Created .ralph/kanban.md (edit this file to add your tasks)"
else
    echo ".ralph/kanban.md already exists"
fi

# Create changelog.md if it doesn't exist
if [ ! -f "$RALPH_DIR/changelog.md" ]; then
    cat > "$RALPH_DIR/changelog.md" <<'EOF'
# Chief Wiggum Changelog

This file tracks all tasks completed by workers.

---

EOF
    echo "Created .ralph/changelog.md (automatic task completion log)"
else
    echo ".ralph/changelog.md already exists"
fi

echo ""
echo "âœ“ Initialized .ralph/ directory"
echo ""
echo "Next steps:"
echo "  1. Edit .ralph/kanban.md to add your tasks"
echo "  2. Run 'wiggum run' to start workers"
echo "  3. Monitor progress with 'wiggum status' or 'wiggum monitor'"
echo ""
