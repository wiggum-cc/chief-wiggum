#!/usr/bin/env bash
# Initialize .ralph/ directory in a project

WIGGUM_HOME="${WIGGUM_HOME:-$HOME/.claude/chief-wiggum}"
PROJECT_DIR="$(pwd)"
RALPH_DIR="$PROJECT_DIR/.ralph"

show_help() {
    cat << EOF
wiggum init - Initialize Chief Wiggum in current project

Usage: wiggum init [options]

Options:
  -h, --help          Show this help message

Description:
  Creates the .ralph/ directory structure in the current project:
    - .ralph/kanban.md    Task board
    - .ralph/changelog.md Completion log
    - .ralph/workers/     Worker directories
    - .ralph/results/     Task results
    - .ralph/logs/        Worker logs

  Requires a git repository to function properly.

Examples:
  wiggum init          # Initialize Chief Wiggum in current project

EOF
}

# Parse options
while [[ $# -gt 0 ]]; do
    case "$1" in
        -h|--help)
            show_help
            exit 0
            ;;
        *)
            echo "Unknown option: $1"
            echo ""
            show_help
            exit 1
            ;;
    esac
done

echo "Initializing Chief Wiggum in $PROJECT_DIR"

# Check if git repo
if [ ! -d ".git" ]; then
    echo "WARNING: Not a git repository. Chief Wiggum requires git for worker isolation."
    echo "Run 'git init' first."
    exit 1
fi

# Create .ralph/ structure
mkdir -p "$RALPH_DIR/workers"
mkdir -p "$RALPH_DIR/results"
mkdir -p "$RALPH_DIR/logs"

# Create kanban template if it doesn't exist
if [ ! -f "$RALPH_DIR/kanban.md" ]; then
    cat > "$RALPH_DIR/kanban.md" <<'EOF'
# Project Kanban

## TASKS

- [ ] **[TASK-001]** Example task
  - Description: This is an example task. Replace with your actual tasks.
  - Priority: HIGH
  - Dependencies: none

EOF
    echo "Created .ralph/kanban.md (edit this file to add your tasks)"
else
    echo ".ralph/kanban.md already exists"
fi

# Create changelog.md if it doesn't exist
if [ ! -f "$RALPH_DIR/changelog.md" ]; then
    cat > "$RALPH_DIR/changelog.md" <<'EOF'
# Chief Wiggum Changelog

This file tracks all tasks completed by workers.

---

EOF
    echo "Created .ralph/changelog.md (automatic task completion log)"
else
    echo ".ralph/changelog.md already exists"
fi

echo ""
echo "âœ“ Initialized .ralph/ directory"
echo ""
echo "Next steps:"
echo "  1. Edit .ralph/kanban.md to add your tasks"
echo "  2. Run 'wiggum run' to start workers"
echo "  3. Monitor progress with 'wiggum status' or 'wiggum monitor'"
echo ""
