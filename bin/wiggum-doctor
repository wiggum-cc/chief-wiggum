#!/usr/bin/env bash
# wiggum doctor - Pre-flight validation command
#
# Checks that the environment is properly configured for Chief Wiggum:
# - Required tools: gh CLI, Claude CLI, jq, git (2.5+), curl, uuidgen, timeout
# - POSIX utilities: grep, cat, date, sed, find, awk, etc.
# - Environment: PATH, disk space, config files, uv, TUI venv, hooks
# - Project: .ralph directory setup
set -euo pipefail

WIGGUM_HOME="${WIGGUM_HOME:-$HOME/.claude/chief-wiggum}"
source "$WIGGUM_HOME/lib/core/exit-codes.sh"
source "$WIGGUM_HOME/lib/core/defaults.sh"
source "$WIGGUM_HOME/lib/core/verbose-flags.sh"
source "$WIGGUM_HOME/lib/core/preflight.sh"

show_help() {
    cat << EOF
wiggum doctor - Pre-flight validation command

Usage: wiggum doctor [options]

Checks:
  Shell & required tools:
  - Bash version (4.0+ for associative arrays)
  - gh CLI installed + authenticated
  - Claude CLI available + responsive
  - jq, bc, curl, uuidgen, setsid, flock, timeout
  - sha256sum/shasum, nproc
  - git version (2.5+ for worktrees)

  POSIX utilities:
  - grep, cat, date, sed, find, awk, sort, etc.

  Environment:
  - WIGGUM_HOME/bin in PATH
  - Disk space (500MB minimum)
  - Configuration files valid (JSON syntax)
  - Pipeline config (valid JSON, agent cross-references)
  - uv (Python package manager)
  - TUI virtual environment
  - Hook scripts executable

  Git & GitHub:
  - Git remote configured + SSH connectivity
  - Git worktree support
  - GitHub token scopes (repo access)
  - Required GitHub labels (wiggum:*, priority:*)

  Project:
  - .ralph directory setup

Options:
  -v, --verbose   Verbose output (same as default)
  -vv             Debug output (detailed diagnostics)
  -vvv            Trace output (very detailed tracing)
  -q, --quiet     Only show failures (no success messages)
  -h, --help      Show this help message

Exit codes:
  0 - All checks passed
  1 - One or more checks failed

Examples:
  wiggum doctor           # Run all checks
  wiggum doctor --quiet   # Only show failures

EOF
}

# Parse verbose flags first
parse_verbose_flags "$@"
set -- "${WIGGUM_REMAINING_ARGS[@]}"

# Parse options
QUIET=false

# Map LOG_LEVEL=WARN to QUIET for backward compatibility
if [[ "${LOG_LEVEL:-}" == "WARN" ]]; then
    QUIET=true
fi

while [[ $# -gt 0 ]]; do
    case "$1" in
        -h|--help)
            show_help
            exit $EXIT_OK
            ;;
        *)
            echo "Unknown option: $1"
            echo ""
            show_help
            exit $EXIT_USAGE
            ;;
    esac
done

# Run checks
if [ "$QUIET" = true ]; then
    # In quiet mode, only show failures
    run_preflight_checks 2>&1 | grep -E '^\[FAIL\]|^       ' || true
    if [ $CHECK_FAILED -gt 0 ]; then
        exit $EXIT_ERROR
    fi
else
    run_preflight_checks
fi

exit $?
