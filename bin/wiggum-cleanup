#!/usr/bin/env bash
# Clean up Chief Wiggum worktrees and worker directories

PROJECT_DIR="$(pwd)"
RALPH_DIR="$PROJECT_DIR/.ralph"

show_help() {
    cat << EOF
wiggum cleanup - Clean up worktrees and worker directories

Usage: wiggum cleanup [options]

Options:
  -h, --help          Show this help message

Description:
  Removes all git worktrees created by workers and cleans up the
  .ralph/workers/ directory. This does not affect the main repository.

Examples:
  wiggum cleanup       # Clean up all worktrees and worker directories

EOF
}

log() {
    echo "[$(date -Iseconds)] $*"
}

# Parse options
while [[ $# -gt 0 ]]; do
    case "$1" in
        -h|--help)
            show_help
            exit 0
            ;;
        *)
            echo "Unknown option: $1"
            echo ""
            show_help
            exit 1
            ;;
    esac
done

if [ ! -d "$RALPH_DIR" ]; then
    echo "ERROR: .ralph/ directory not found"
    exit 1
fi

log "Cleaning up Chief Wiggum worktrees and workers..."

# Remove all worktrees
worktree_count=0
for worktree in "$RALPH_DIR/workers"/worker-*/workspace; do
    if [ -d "$worktree" ]; then
        log "Removing worktree: $worktree"
        git worktree remove "$worktree" --force 2>/dev/null || true
        ((worktree_count++))
    fi
done

# Prune stale worktree references
git worktree prune

# Clean up worker directories
if [ -d "$RALPH_DIR/workers" ]; then
    worker_count=$(find "$RALPH_DIR/workers" -mindepth 1 -maxdepth 1 -type d | wc -l)
    if [ "$worker_count" -gt 0 ]; then
        log "Removing $worker_count worker director(y|ies)..."
        rm -rf "$RALPH_DIR/workers"/*
    fi
fi

log "âœ“ Cleanup complete"
log "  Removed $worktree_count worktree(s)"

# Show current status
echo ""
log "Current status:"
git worktree list
