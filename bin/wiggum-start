#!/usr/bin/env bash
# wiggum start - Manually start a worker for a task
#
# Usage:
#   wiggum start <TASK-ID>         Start a new worker for the specified task
#   wiggum start <TASK-ID> plan    Start with planning phase first

set -euo pipefail

WIGGUM_HOME="${WIGGUM_HOME:-$HOME/.claude/chief-wiggum}"
PROJECT_DIR="$(pwd)"
RALPH_DIR="$PROJECT_DIR/.ralph"

source "$WIGGUM_HOME/lib/core/exit-codes.sh"
source "$WIGGUM_HOME/lib/core/logger.sh"
source "$WIGGUM_HOME/lib/core/file-lock.sh"
source "$WIGGUM_HOME/lib/tasks/task-parser.sh"
source "$WIGGUM_HOME/lib/utils/audit-logger.sh"
source "$WIGGUM_HOME/lib/worker/worker-lifecycle.sh"
source "$WIGGUM_HOME/lib/worker/agent-registry.sh"

# Default configuration
MAX_ITERATIONS=20
MAX_TURNS=50
AGENT_TYPE="task-worker"

show_help() {
    cat << EOF
wiggum start - Manually start a worker for a task

Usage:
  wiggum start <id>         Start a new worker for the specified task
  wiggum start <id> plan    Start with planning phase first

Task ID Resolution:
  Task IDs can be partial as long as they match exactly one task:
  - 030                (number only)
  - K-030              (partial task ID)
  - TASK-030           (full task ID)

Options:
  --max-iters N   Maximum iterations per worker (default: 20)
  --max-turns N   Maximum turns per Claude session (default: 50)
  --agent-type T  Agent type to use (default: task-worker)
  --pipeline NAME Pipeline config to use (from config/pipelines/ or .ralph/pipelines/)
  -h, --help      Show this help message

Examples:
  wiggum start TASK-030          # Start worker for TASK-030
  wiggum start 030               # Start worker matching "030"
  wiggum start FEAT-001          # Start worker for FEAT-001
  wiggum start TASK-030 plan     # Start with planning phase

Notes:
  - The task must exist in .ralph/kanban.md
  - Use 'plan' to run the plan-mode agent before execution
  - If a plan already exists in .ralph/plans/, it will be used automatically
  - Use 'wiggum run' for automated orchestration of multiple tasks
  - Use 'wiggum resume <id>' to resume a stopped worker

EOF
}

# Start a new worker for a task
do_start() {
    local input_id="$1"

    if [ -z "$input_id" ]; then
        echo "Error: Task ID required"
        echo "Usage: wiggum start <TASK-ID>"
        exit $EXIT_WORKER_MISSING_TASK_ID
    fi

    # Check .ralph directory exists
    if [ ! -d "$RALPH_DIR" ]; then
        echo "Error: No .ralph directory found. Run 'wiggum init' first."
        exit $EXIT_WORKER_NO_RALPH_DIR
    fi

    # Check if kanban exists
    if [ ! -f "$RALPH_DIR/kanban.md" ]; then
        echo "Error: No kanban.md found at $RALPH_DIR/kanban.md"
        exit $EXIT_WORKER_NO_KANBAN
    fi

    # Resolve partial task ID to full task ID
    local task_id
    task_id=$(resolve_task_id "$RALPH_DIR/kanban.md" "$input_id") || exit $EXIT_WORKER_TASK_NOT_FOUND

    # Check if a worker already exists for this task (using shared library)
    # Exclude plan workers (worker-TASK-xxx-plan-*) - those are read-only planning sessions
    local existing
    existing=$(find_any_worker_by_task_id "$RALPH_DIR" "$task_id" | grep -v -- '-plan-' || true)
    if [ -n "$existing" ]; then
        echo "Warning: Worker already exists for $task_id: $(basename "$existing")"
        echo "Use 'wiggum resume $task_id' to resume it, or 'wiggum clean $task_id' first."
        exit $EXIT_WORKER_ALREADY_EXISTS
    fi

    # Update kanban status to in-progress (wip)
    if ! update_kanban_status "$RALPH_DIR/kanban.md" "$task_id" "="; then
        echo "Warning: Failed to update kanban status to in-progress"
    fi

    # Create worker directory with unique timestamp
    local timestamp
    timestamp=$(date +%s)
    local worker_id="worker-${task_id}-${timestamp}"
    local worker_dir="$RALPH_DIR/workers/$worker_id"

    mkdir -p "$worker_dir"
    mkdir -p "$RALPH_DIR/logs"

    # Extract task from kanban and create worker PRD
    extract_task "$task_id" "$RALPH_DIR/kanban.md" > "$worker_dir/prd.md"

    echo "Starting worker $worker_id for task $task_id"

    # Launch task-worker agent in background
    # run_agent writes PID to agent.pid - orchestrator can poll for it
    # Use setsid to create a new session/process group for the worker
    # This prevents SIGINT from the orchestrator from killing workers
    # shellcheck disable=SC2016
    setsid bash -c '
        export WIGGUM_HOME="'"$WIGGUM_HOME"'"
        source "$WIGGUM_HOME/lib/worker/agent-registry.sh"
        run_agent "'"$AGENT_TYPE"'" "'"$worker_dir"'" "'"$PROJECT_DIR"'" 30 "'"$MAX_ITERATIONS"'" "'"$MAX_TURNS"'"
    ' >> "$RALPH_DIR/logs/workers.log" 2>&1 &

    # Wait briefly for agent.pid to be created
    local wait_count=0
    while [ ! -f "$worker_dir/agent.pid" ] && [ $wait_count -lt 10 ]; do
        sleep 0.1
        ((wait_count++)) || true
    done

    if [ -f "$worker_dir/agent.pid" ]; then
        local worker_pid
        worker_pid=$(cat "$worker_dir/agent.pid")
        echo "Worker running (PID: $worker_pid)"
    else
        echo "Worker started (PID file pending)"
    fi
    echo "Use 'wiggum monitor' to follow progress"
}

# Main
main() {
    local task_id_arg=""

    while [[ $# -gt 0 ]]; do
        case "$1" in
            -h|--help)
                show_help
                exit $EXIT_OK
                ;;
            --max-iters)
                if [[ -z "${2:-}" ]] || [[ "${2:-}" =~ ^- ]]; then
                    echo "Error: --max-iters requires a number argument"
                    exit $EXIT_USAGE
                fi
                MAX_ITERATIONS="$2"
                shift 2
                ;;
            --max-turns)
                if [[ -z "${2:-}" ]] || [[ "${2:-}" =~ ^- ]]; then
                    echo "Error: --max-turns requires a number argument"
                    exit $EXIT_USAGE
                fi
                MAX_TURNS="$2"
                shift 2
                ;;
            --agent-type)
                if [[ -z "${2:-}" ]] || [[ "${2:-}" =~ ^- ]]; then
                    echo "Error: --agent-type requires an argument"
                    exit $EXIT_USAGE
                fi
                AGENT_TYPE="$2"
                shift 2
                ;;
            --pipeline)
                if [[ -z "${2:-}" ]] || [[ "${2:-}" =~ ^- ]]; then
                    echo "Error: --pipeline requires a name argument"
                    exit $EXIT_USAGE
                fi
                export WIGGUM_PIPELINE="$2"
                echo "Using pipeline: $2"
                shift 2
                ;;
            plan)
                export WIGGUM_PLAN_MODE=true
                echo "Using plan mode"
                shift
                ;;
            -*)
                echo "Unknown option: $1"
                show_help
                exit $EXIT_USAGE
                ;;
            *)
                if [ -z "$task_id_arg" ]; then
                    task_id_arg="$1"
                else
                    echo "Unexpected argument: $1"
                    exit $EXIT_USAGE
                fi
                shift
                ;;
        esac
    done

    if [ -z "$task_id_arg" ]; then
        echo "Error: Task ID required"
        echo "Usage: wiggum start <TASK-ID> [plan] [--max-iters N] [--max-turns N] [--pipeline NAME]"
        exit $EXIT_USAGE
    fi

    do_start "$task_id_arg"
}

main "$@"
