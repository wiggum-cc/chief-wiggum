#!/usr/bin/env bash
# wiggum-github - CLI for GitHub issue sync
#
# Usage:
#   wiggum github                         Full sync cycle (down + up)
#   wiggum github down                    Pull issues -> kanban only
#   wiggum github up                      Push kanban -> GitHub only
#   wiggum github sync up <TASK-ID|all>   Create GitHub issues for untracked tasks
#   wiggum github plan-sync [TASK-ID]     Sync plan files with GitHub issue comments
#   wiggum github status                  Show sync state summary
#   wiggum github --dry-run               Show planned changes without writing
set -euo pipefail

WIGGUM_HOME="${WIGGUM_HOME:-$HOME/.claude/chief-wiggum}"

source "$WIGGUM_HOME/lib/core/exit-codes.sh"
source "$WIGGUM_HOME/lib/core/defaults.sh"
source "$WIGGUM_HOME/lib/core/logger.sh"
source "$WIGGUM_HOME/lib/core/verbose-flags.sh"
source "$WIGGUM_HOME/lib/github/issue-config.sh"
source "$WIGGUM_HOME/lib/github/issue-sync.sh"

show_help() {
    cat << EOF
wiggum github - Sync GitHub issues with local kanban

Usage: wiggum github [command] [options]

Commands:
  (none)                       Full sync cycle (down + up)
  down                         Pull GitHub issues to local kanban only
  up                           Push local kanban status to GitHub only
  sync up <TASK-ID|all> [-y]   Create GitHub issues for untracked kanban tasks
  plan sync [TASK-ID|all]      Sync plan files with GitHub issue comments
  status                       Show sync state summary

Options:
  --dry-run              Show planned changes without writing
  --force up|down        Resolve plan-sync conflicts (up=local wins, down=remote wins)
  -y                     Skip confirmation prompt (for sync up)
  -h, --help             Show this help

Examples:
  wiggum github                              # Full sync
  wiggum github down                         # Import new issues
  wiggum github up                           # Push status changes
  wiggum github sync up TASK-333             # Create issue for one task
  wiggum github sync up all                  # Create issues for all untracked
  wiggum github sync up all -y               # Skip confirmation
  wiggum github plan-sync                    # Sync non-terminal plans
  wiggum github plan-sync all                # Sync all plans (including completed)
  wiggum github plan-sync TASK-001           # Sync one task's plan
  wiggum github plan-sync --dry-run          # Preview plan-sync changes
  wiggum github plan-sync --force up         # Push local plans (resolve conflicts)
  wiggum github plan-sync --force down       # Pull remote plans (resolve conflicts)
  wiggum github --dry-run                    # Preview changes
  wiggum github status                       # Show state

Configuration:
  Set in .ralph/config.json or config/config.json under github.issue_sync.
  Enable with: "enabled": true
  Required: allowed_user_ids must be configured.

Environment:
  WIGGUM_GITHUB_ISSUE_SYNC=true        Enable sync
  WIGGUM_GITHUB_ALLOWED_USER_IDS=...   Comma-separated user IDs
  WIGGUM_GITHUB_LABEL_FILTER=wiggum    Gate label (default: wiggum)

EOF
}

main() {
    # Parse verbose flags first
    parse_verbose_flags "$@"
    set -- "${WIGGUM_REMAINING_ARGS[@]}"

    local command=""
    local dry_run="false"
    local skip_confirm="false"
    local sync_target=""
    local plan_sync_task_id=""
    local force_direction=""

    # Parse arguments
    while [[ $# -gt 0 ]]; do
        case "$1" in
            -h|--help)
                show_help
                exit $EXIT_OK
                ;;
            --dry-run)
                dry_run="true"
                shift
                ;;
            -y)
                skip_confirm="true"
                shift
                ;;
            plan)
                # Handle "plan-sync [TASK-ID] [--force up|down]"
                shift
                if [[ $# -gt 0 ]] && [[ "$1" == "sync" ]]; then
                    command="plan-sync"
                    shift
                    while [[ $# -gt 0 ]]; do
                        case "$1" in
                            --dry-run)
                                dry_run="true"; shift ;;
                            --force)
                                if [[ $# -lt 2 ]]; then
                                    echo "Error: --force requires 'up' or 'down'" >&2
                                    exit $EXIT_USAGE
                                fi
                                force_direction="$2"; shift 2 ;;
                            -h|--help)
                                show_help; exit $EXIT_OK ;;
                            -*)
                                echo "Unknown option: $1" >&2
                                exit $EXIT_USAGE ;;
                            *)
                                plan_sync_task_id="$1"; shift ;;
                        esac
                    done
                else
                    echo "Error: Unknown plan subcommand. Use 'plan-sync [TASK-ID]'" >&2
                    exit $EXIT_USAGE
                fi
                ;;
            sync)
                # Handle "sync up <target>"
                shift
                if [[ $# -gt 0 ]] && [[ "$1" == "up" ]]; then
                    command="sync-up"
                    shift
                    if [[ $# -gt 0 ]] && [[ "$1" != -* ]]; then
                        sync_target="$1"
                        shift
                    else
                        echo "Error: 'sync up' requires a task ID or 'all'" >&2
                        echo "Usage: wiggum github sync up <TASK-ID|all> [-y]" >&2
                        exit $EXIT_USAGE
                    fi
                else
                    echo "Error: Unknown sync subcommand. Use 'sync up <TASK-ID|all>'" >&2
                    exit $EXIT_USAGE
                fi
                ;;
            down|up|status)
                command="$1"
                shift
                ;;
            *)
                echo "Unknown argument: $1" >&2
                show_help
                exit $EXIT_USAGE
                ;;
        esac
    done

    # Verify ralph directory
    if [ ! -d "$RALPH_DIR" ]; then
        log_error "Ralph directory not found: $RALPH_DIR"
        echo "Run 'wiggum init' first."
        exit $EXIT_RUN_NO_RALPH_DIR
    fi

    # Load and validate config
    load_github_sync_config

    if ! github_sync_is_enabled; then
        echo "GitHub issue sync is disabled."
        echo "Enable it in .ralph/config.json: {\"github\": {\"issue_sync\": {\"enabled\": true}}}"
        echo "Or set: WIGGUM_GITHUB_ISSUE_SYNC=true"
        exit $EXIT_OK
    fi

    if ! github_sync_validate_config; then
        log_error "GitHub sync configuration is invalid"
        exit $EXIT_ERROR
    fi

    # Dispatch command
    case "${command:-}" in
        ""|down|up|sync-up|plan-sync)
            if [ "$dry_run" = "true" ]; then
                echo "=== Dry Run Mode ==="
                echo ""
            fi
            ;;
    esac

    case "${command:-}" in
        "")
            # Full sync
            github_issue_sync "$RALPH_DIR" "$dry_run"
            ;;
        down)
            github_issue_sync_down "$RALPH_DIR" "$dry_run"
            ;;
        up)
            github_issue_sync_up "$RALPH_DIR" "$dry_run"
            ;;
        sync-up)
            github_issue_sync_up_create "$RALPH_DIR" "$sync_target" "$dry_run" "$skip_confirm"
            ;;
        plan-sync)
            source "$WIGGUM_HOME/lib/github/plan-sync.sh"
            github_plan_sync "$RALPH_DIR" "$plan_sync_task_id" "$dry_run" "$force_direction"
            ;;
        status)
            github_issue_sync_status "$RALPH_DIR"
            ;;
    esac
}

main "$@"
